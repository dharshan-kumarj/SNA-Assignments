stages:
  - build
  - test
  - deploy

image: docker:latest
services:
  - docker:dind

variables:
  DOCKER_DRIVER: overlay2

build_app:
  stage: build
  script:
    - echo "Building Docker Image..."
    - docker build -t $CI_REGISTRY_IMAGE -f docker/Dockerfile .
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker push $CI_REGISTRY_IMAGE

test_app:
  stage: test
  script:
    - echo "Running Tests..."
    # In a real scenario, you'd run PHPUnit here
    - echo "Tests Passed!"

deploy_prod:
  stage: deploy
  only:
    - main
  script:
    - echo "Deploying to Lab Server..."
    # Example deployment command (SSH or similar)
    - echo "Deployment Complete."
